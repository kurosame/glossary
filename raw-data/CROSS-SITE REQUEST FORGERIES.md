## category

network

## titles

Cross-Site Request Forgeries
CSRF
クロスサイトリクエストフォージェリ

## description

以下のような攻撃のことである

1. 脆弱なサイトにログイン
1. そのサイトで悪意のあるサイトの URL をクリック
1. 意図しないリクエストを脆弱なサイトへ送らせる（脆弱なサイトとはログインしていないまったく無関係なサイトも含む）

これを防ぐには脆弱なサイト側で対策が必要である

CSRF はセッション管理における脆弱性を狙う攻撃で、ログイン済みユーザーになりすまして不正操作を行う  
XSS はサイトの入力フォームに罠を仕掛ける攻撃で、そこにユーザーがアクセスした時に悪意のあるサイトに誘導し、スクリプトを実行させ、個人情報などを盗む攻撃

### 必要な対策

異なるオリジンからの読み取りはブラウザの Same-Origin Policy によりブロックされ、エラーにしてくれる  
CSRF 対策が必要なのは、異なるオリジンへのリクエストである  
パスワードなどのセキュアな情報を入力するフォームを持つサイトの場合、対策が必要である

- トークンの発行  
  サーバサイド側でトークンを発行し、たとえば Cookie に保持させる  
  フロントエンド側で HTTP リクエストを送る際は必ずリクエストヘッダーにトークンを含むように実装しておく

  悪意のあるユーザがサイトの利用者に成りすますには、少なくとも利用者のログイン情報等が必要なため、フォーム画面を偽装したサイトを攻撃者側に作成する必要がある  
  もし、トークンが不要であれば、その攻撃者のフォーム画面から簡単に偽装したリクエストをサーバサイドに送りつけ、DB 格納などの処理をさせてしまう

  トークンが必須の場合、攻撃者は利用者のトークンを取得する必要がある  
  ただし、ブラウザの Same-Origin Policy により、Fetch API などを使ってトークンを読み取ることはできない

- レスポンスヘッダーに Access-Control-Allow-Origin を含める  
  許可するオリジンのみを常に返す  
  ブラウザはこれを見てブロックするか判断する
