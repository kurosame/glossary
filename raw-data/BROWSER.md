## category

browser

## titles

Browser
ブラウザ

## description

### URL を入力してから、ページが表示されるまでの流れ

1. HTTP リクエストを Web Server へ投げる
1. DNS による名前解決で、サーバの IP アドレスを取得
1. サーバへリクエストを投げて、レスポンスを取得
1. ブラウザのレンダリングエンジンによる描画処理（以下のレンダリングの流れを参照）

### レンダリングの流れ

1. Loading  
   HTML、JavaScript、CSS、画像などのサブリソースをサーバからダウンロードする  
   ブラウザのレンダリングエンジンの内部表現にパースして変換（HTML を DOM に変換、CSS を CSSOM に変換）  
   レンダリングを行うパーサーが外部の CSS や JS を見つけると、それらを読み込む

   - CSS  
     パーサーは CSS の読み込み中も実行されるが、読み込み後、CSSOM が構築される間はレンダリングブロックされる
   - JS  
     パーサーは JS の読み込み中および、実行中はレンダリングブロックされる  
     `<script>`タグに async/defer を付与することで、JS 読み込みを非同期にすることができ、その間もパーサーを実行させることができる

1. Scripting  
   JavaScript のコードを JavaScript エンジンに渡して実行  
   コードを AST にパースしてコンパイルし、機械コードにして実行  
   初回実行以外に DOM からイベントが発火する際も同様に行われる

1. Rendering

   1. すべての DOM に適切な CSSOM を紐づけ、レンダリングツリーを作成する
   1. リフローと呼ばれる各要素の位置、サイズを計算する（height, width, padding, margin など）

1. Painting  
   最後に描画する  
   Paint Records と Layer Tree を作成し、Rasterize へ処理を移す  
   ここまでの処理はメインスレッドで行われる

   - Paint Records  
     画面上で要素が重なる部分を適切な順番で描画するようにする

   - Layer Tree  
     変更の際の計算量を少なくするため、ツリーを分離する

1. Rasterize  
   ここからの処理はコンポジットスレッドで行う  
   Paint Records を基に描画、Layer Tree の合成を行う（transform, opacity など）

リフローは重い、かつ、メインスレッドで行うため、極力避けた方が良い  
コンポジットスレッドで行う処理はメインスレッドの影響を受けないため、パフォーマンス低下の懸念が少ない

### フレームレート

FPS という単位で表現される  
FPS は 1 秒毎で何枚の静止画で構成されている動画なのかを表す単位  
ブラウザの場合、60fps が目標値（1 秒毎に 60 枚の静止画で構成された動画）  
重いレンダリング処理が走るとフレームレートの値が下がり、画面のカクつきやアニメーションの劣化を招く

### レンダリングブロック

- レンダリングブロックされる

  - CSSOM 構築  
    完全に構築されるまでレンダリングをストップする
  - 外部 JS 読み込み  
    `<script>`タグで外部から読み込むとその間レンダリングをストップする
  - JS 実行中

- レンダリングブロックされない

  - DOM 構築  
    構築された DOM が随時画面に反映される
  - 外部 CSS 読み込み
  - 非同期による外部 JS 読み込み
  - JS 実行前  
    JS が実行する前までの DOM 構築を行う
