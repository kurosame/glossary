## category

server

## titles

ロードバランサー

## description

NAT、SNAT、DSR という構成がある

### NAT（Network Address Translation）

1. クライアントはロードバランサーと通信を行う
   - ロードバランサーは各サーバーの代表 IP アドレスを持つ
1. ロードバランサーはパケットを受信すると、パケットのヘッダーの IP アドレスをサーバーのものに書き換えてそのサーバーに転送する
   - この IP アドテクを書き換える仕組みを NAT と呼ぶ
1. レスポンス時は再度ロードバランサーを経由してパケットを返す
   - IP アドレスを書き換えたので、再度ロードバランサーの IP に書き換えないと、クライアント側で破棄されるため（クライアントはロードバランサーの IP に対して通信したため）

### SNAT（Source NAT）

クライアントとサーバーの間にロードバランサーではなく、ルーターを配置する構成もある  
この場合、ルーターがロードバランサーとやり取りする  
しかし、サーバーはルーターにパケット返すので、ロードバランサーによる IP 書き換えができなくなってしまう

これを SNAT という仕組みで回避できる

1. クライアントはロードバランサーと通信を行う（ルーターを介して）
1. ロードバランサーはパケットを受信すると、宛先 IP（サーバー）だけでなく、送信元 IP（クライアント）も書き換える
   - この場合、ロードバランサーは代表 IP アドレス（クライアントと通信するための）とは別にもう 1 つの IP アドレス（サーバーと通信するための）を持つことになる
1. サーバーはロードバランサーへパケットを返すことができる
1. ロードバランサーの IP に書き換えて、クライアントに返却する

この構成のデメリットは、サーバーのログを見てもどのクライアントが分からないこと（送信元 IP アドレス（クライアント）をロードバランサーのものに書き換えてるから）  
`X-Forwarded-For`ヘッダーと併用することでこの問題は回避できる

### DSR（Direct Server Return）

送信元 IP アドレスを隠したくない場合、宛先 IP アドレスも送信元 IP アドレスも書き換えない DSR という方法がある  
これは、ロードバランサーの代表 IP アドレスをすべてのサーバーに持たせておくやり方である  
こうすることで宛先 IP アドレスを各サーバーの IP アドレスに書き換えなくても、サーバーにパケットを送信できる  
そして、ヘッダーを書き換えていないので、ロードバランサーに戻さず、そのままクライアントへ返却できる

この方法のメリットは

- 送信元 IP アドレス（クライアント）が隠せない
- レスポンス時にロードバランサーを経由しないので、ロードバランサーの負荷軽減になる

デメリットは、ロードバランサーとサーバーの設定が複雑になること
