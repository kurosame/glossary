## category

architecture

## titles

Blockchain
ブロックチェーン

## description

一定時間内の複数の取引記録（トランザクション）を 1 つのブロックとする  
そのブロックを時系列でチェーンのように繋げて管理すること  
その際 1 つ前のブロックのハッシュ値をその次のブロックに含めている  
ビットコインの場合は、10 分以内に発生した取引全てが 1 つの同じブロックに入る

ブロックチェーンでは、データを更新せずにトランザクションの積み重ねで通貨の移動を表現する  
ブロックもトランザクションもイミュータブルである

あるブロックのデータを改竄すると、その後全てのブロックのハッシュ値が変わることになる  
改竄をしようと考えれば、そのブロックの取引だけでなく、そのブロック以降のデータも書き換えないといけない

ビットコインの場合、送信者が受信者に送金した場合、そのやり取りが取引情報として書き込まれる  
その際、残高があると送信者は自分宛てにその残高全てを送金するというデータを書き込む必要がある  
ブロックチェーンに残高を管理する機能はなく、取引情報しか管理しないため、上記の処理が必要  
また送信者が送金する際には手数料がかかる、その手数料はマイニングに成功したマイナーに報奨として支払われる

ブロックチェーンでは、分散したノードは 1 つの台帳を全員で管理している  
反対に分散型 DB では、分散したノードは個別に台帳を管理している

### 送信者の本人確認

新しい取引は秘密鍵の所有者（送信者）が作成  
送信者が秘密鍵から公開鍵を作成  
公開鍵からアドレス（口座番号）を作成  
そのアドレス等を含んだ送金情報（取引）を秘密鍵を使い電子署名する  
P2P ネットワークに送金情報をブロードキャスト  
送金情報（取引）に含まれる公開鍵と秘密鍵での電子署名を照合して、送信者が正しいことを確認する

### 取引データの管理

ブロックチェーンのネットワークの参加者の誰かが新しいブロックを配布  
各参加者はそのブロックを検証後、追加  
追加できる人を決める仕組みは以下の 2 つがある

- Proof of Work  
  ブロックを配布できるのは計算を速く解いた参加者という仕組み  
  number used once（nonce: ナンス）という 1 度しか使われない 32 ビットのランダムな数値を求める計算  
  他の参加者はその計算結果を検証し、正解なら自分のブロックチェーンに追加する

  「前のブロックのハッシュ値 + 取引データ + ナンス値」で次のブロックのハッシュ値を作れるが、  
  ハッシュ値の最初に一定数以上 0 が続くという条件を満たすハッシュ値を生成する必要がある  
  前のブロックのハッシュ値と取引データは変更不可の為、ナンス値を色々変えながらハッシュ値の条件を満たすナンス値を探す  
  そのナンス値を早く見つけた者にブロックを追加する権利がある

- Proof of Stake  
  ブロックを配布できるのはコインの保有割合から選ばれた参加者という仕組み

- ブロックチェーンのフォーク（分岐）  
   分岐が発生するのは、以下 2 つのケース

  1.  同じタイミングでブロックが複数マイニング（取引の承認とブロックの生成）される  
      フォークされたまま参加者は自由にブロックを追加し、最終的には長い方のブロックチェーンを正とする

  1.  ハードフォークとソフトフォーク

      - ハードフォーク  
        互換性のない仕様変更  
        ブロックチェーンの永続的なフォークを引き起こすもの  
        以下の 3 パターンがある

        1.  ブロックチェーンのバグ対応などによるアップデート  
            こちらのハードフォークではコミュニティの全参加者が賛成しているので、分裂が起きることはない

        1.  コミュニティの対立によるコインの分裂  
            仕様変更を巡ってコミュニティで対立すると分裂したまま、旧ルールと新ルール両方にマイニングされるため、  
            それぞれで別々のビットコインが誕生することとなる

        1.  アルトコインの開発  
            ブロックチェーンの機能を変更し、ハードフォークすることで別のコインを生成する

      - ソフトフォーク  
        互換性のある仕様変更が原因で起こる一時的な分岐  
        具体的にはブロックを追加するルールを決めたり、厳しくしたりする時  
        ソフトフォークは過半数のマイナー（マイニングする人）が新ルールに従うと決まった段階で発生するため、  
        最終的には新ルールのブロックチェーンが長くなり、収束する

### フォークの改竄について

意図的に不正なブロックを作成しフォークさせ、正当なブロックを破棄させる  
ただし、実現には不正なマイニングを行う人が過半数必要だが、現実的に不可能に近い  
仮に成功してもそのビットコインは信頼性を失い、価値が暴落するだろう
